!function($){let defaults={name:"otp",length:4,animation:{fade:600,position:600},fetch:{requestOTP:{url:"http://localhost:3001/api/request.json",options:{method:"GET",headers:{"Content-Type":"application/json"}}},validateOTP:{url:"http://localhost:3001/api/validate.json",options:{method:"GET",headers:{"Content-Type":"application/json"}}}},i18n:{title:"Σύνδεση",label:"Κωδικός μια χρήσης",help:"Παρακαλώ εισάγετε τον κωδικό μιας χρήσης που σας έχει αποσταλλεί.",resend:"ΕΠΑΝΑΠΟΣΤΟΛΗ",validate:"ΣΥΝΕΧΕΙΑ",expired:"O κωδικός που στάλθηκε έχει λήξει.",invalid:"O κωδικός δεν είναι σωστός."},events:{onRequest:function(res){var res=res.duration,compensation=(Date.now()-this.requested)/2;this.duration=res,this.expires=new Date(this.requested+(this.duration-compensation)).getTime()},onValidate:function(res){return"valid"in res&&!0===res.valid}}};$.fn.OTP=function(options=defaults){let charArr=[],instance={},{name,length,i18n,animation}=options;var{title,label,help,expired,invalid,resend,validate}=i18n;function onSubmit(evt){evt.preventDefault(),evt.stopImmediatePropagation()}return instance.interval=null,instance.duration=null,instance.requested=null,instance.expires=null,instance.options=options,instance.active=!1,instance.$otp=$(`

            <div class="otp-bg">
                <div class="otp-modal">
                    <div class="otp-modal-header">
                        <h3 class="otp-title">${title}</h3>
                        <svg width="64" height="64" viewBox="0 0 128 128" class="otp-timeout">
                            <circle class="bg"></circle>
                            <circle class="fg"></circle>
                        </svg>
                    </div>
                    <div class="otp-modal-body">
                        <label class="otp-label">${label}</label>
                        <div class="otp-char-container">
                            ${(()=>{var arr=[];for(let i=0;i<length;i++)arr.push(`<input class="otp-char otp-char-${i}" type="text" maxlength="1" autocorrect="off" autocomplete="off" />`);return arr.join("\n")})()}
                        </div>
                        <small class="otp-help">${help}</small>
                        <div class="otp-alert otp-invalid">${invalid}</div>
                        <div class="otp-alert otp-expired">${expired}</div>
                    </div>
                    <div class="otp-modal-footer">
                        <button class="otp-resend-btn-footer">${resend}</button>
                        <button class="otp-validate-btn-footer" disabled>${validate}</button>
                    </div>
                </div>
                <input class="otp-input" name="${name}" type="hidden" />
            </div>
            
        `),instance.$container=this,instance.$form=instance.$container.closest("form"),instance.$modal=instance.$otp.find(".otp-modal"),instance.$timeout=instance.$otp.find(".otp-timeout"),instance.$chars=instance.$otp.find(".otp-char"),instance.$input=instance.$otp.find(".otp-input"),instance.$resend=instance.$otp.find(".otp-resend-btn-footer"),instance.$validate=instance.$otp.find(".otp-validate-btn-footer"),instance.$chars.on("keydown",function(evt){var $this=$(this),{}=this;"tab"===evt.key.toLowerCase()&&(evt.preventDefault(),evt.stopImmediatePropagation(),(evt=$this.next(".otp-char")).length)&&(evt.focus(),evt.get(0).setSelectionRange(0,0))}),instance.$chars.on("input",function(evt){var $this=$(this),index=$this.index(),value=$this.val();value.length&&(($this=$this.next(".otp-char")).length&&!$this.val().length&&$this.focus(),charArr[index]=value,instance.$input.val(charArr.join("")),instance.$input.trigger("otp:change"))}),instance.$chars.on("keyup",function(evt){let $this=$(this);var key=evt.key.toLowerCase();let{selectionStart,selectionEnd}=this;switch(key){case"backspace":var index=$this.index(),$prev=$this.prev(".otp-char");0!==selectionStart&&0!==selectionEnd||(evt.preventDefault(),evt.stopImmediatePropagation()),$prev.length&&($prev.focus(),$prev.get(0).setSelectionRange(1,1)),charArr[index]="",instance.$input.val(charArr.join("")),instance.$input.trigger("otp:change");break;case"delete":{let index=$this.index();var value,$prev=$this.nextAll(".otp-char");$prev.length&&(0!==selectionStart&&0!==selectionEnd||(value=$this.next().val(),charArr[index]=value,$this.val(value)),$prev.each(function(index,el){var el=$(el),value=el.next().val(),$next=el.next(".otp-char");$next.length&&$next.val()?el.val($next.val()):el.val(""),$this.get(0).setSelectionRange(selectionStart,selectionEnd),charArr[index]=value}),instance.$input.val(charArr.join("")),instance.$input.trigger("otp:change"));break}case"arrowleft":{let $prev=$this.prev(".otp-char");$prev.length&&($prev.focus(),$prev.get(0).setSelectionRange(1,1));break}case"arrowright":index=$this.next(".otp-char");index.length&&(index.focus(),index.get(0).setSelectionRange(0,0))}}),instance.$input.on("otp:change",function(evt){$(this).val().length===length?instance.$validate.prop("disabled",!1):instance.$validate.prop("disabled",!0)}),instance.show=async function(f=()=>{}){if(!instance.active){try{instance.active=!0,instance.requested=Date.now(),await instance.request(),instance.interval=setInterval(()=>{Date.now()>=instance.expires&&(clearInterval(instance.interval),instance.$otp.addClass("expired"))},1e3),instance.$timeout.css("animation-duration",instance.duration+"ms"),instance.$otp.addClass("visible")}catch(err){return clearInterval(instance.interval),instance.$resend.prop("disabled",!1),instance.$otp.removeClass("visible expired invalid"),instance.$timeout.css("animation-duration",""),instance.interval=null,instance.duration=null,instance.requested=null,instance.expires=null,instance.active=!1,void console.error(`An error occurred because of ${err.message}, while requesting an one time password!`)}instance.$otp.trigger("otp:show"),instance.$otp.stop(!0,!1).fadeIn(animation.fade),instance.$modal.stop(!0,!1).animate({transform:50,top:"50%"},{duration:animation.position,step:function(now,fx){"transform"===fx.prop&&instance.$modal.css("transform",`translateX(-50%) translateY(${now-100}%)`)},complete:function(){f instanceof Function&&f(),instance.$otp.trigger("otp:shown")}})}},instance.hide=function(f=()=>{}){instance.active&&(instance.$otp.trigger("otp:hide"),instance.$modal.stop(!0,!1).animate({transform:50,top:"0%"},{duration:animation.position,step:function(now,fx){"transform"===fx.prop&&instance.$modal.css("transform",`translateX(-50%) translateY(-${50+now}%)`)}}),instance.$otp.stop(!0,!1).fadeOut(animation.fade,function(){clearInterval(instance.interval),instance.$otp.removeClass("visible expired invalid"),instance.$timeout.css("animation-duration",""),instance.interval=null,instance.duration=null,instance.requested=null,instance.expires=null,instance.active=!1,f instanceof Function&&f(),instance.$otp.trigger("otp:hidden")}))},instance.destroy=function(){instance.$form.length&&instance.$form.off("submit",onSubmit),this.$container.removeData("otp"),this.$otp.remove()}.bind(instance),instance.refresh=function(){this.destroy(),this.$container.OTP(options)}.bind(instance),instance.request=async function(){var requestOTP=this.options.fetch.requestOTP,requestOTP=await(await fetch(requestOTP.url,requestOTP.options)).json();this.options.events.onRequest.call(this,requestOTP)}.bind(instance),instance.validate=async function(){try{var payload,data,validateOTP=this.options.fetch.validateOTP;if("post"===validateOTP.options.method.toLowerCase())return payload=JSON.stringify({[name]:instance.$input.val()}),data=await(await fetch(validateOTP.url,{...validateOTP.options,body:payload})).json(),this.options.events.onValidate.call(this,data);{var url=new URL(validateOTP.url);url.searchParams.set(name,instance.$input.val());let resp=await fetch(url,validateOTP.options),data=await resp.json();return this.options.events.onValidate.call(this,data)}}catch(err){console.error(`An error occurred because of ${err.message}, while validating an one time password!`)}return!1}.bind(instance),instance.$resend.on("click",async function(evt){try{clearInterval(instance.interval),instance.$otp.removeClass("visible expired invalid"),instance.$timeout.css("animation-duration",""),instance.interval=null,instance.duration=null,instance.requested=null,instance.expires=null,instance.active=!1,instance.requested=Date.now(),instance.$resend.prop("disabled",!0),await instance.request(),instance.$resend.prop("disabled",!1),instance.interval=setInterval(()=>{Date.now()>=instance.expires&&(clearInterval(instance.interval),instance.$otp.addClass("expired"))},1e3),instance.$timeout.css("animation-duration",instance.duration+"ms"),instance.$otp.addClass("visible")}catch(err){clearInterval(instance.interval),instance.$resend.prop("disabled",!1),instance.$otp.removeClass("visible expired invalid"),instance.$timeout.css("animation-duration",""),instance.interval=null,instance.duration=null,instance.requested=null,instance.expires=null,console.error(`An error occurred because of ${err.message}, while requesting a new one time password!`)}}),instance.$form.length?(instance.$form.on("submit",onSubmit),instance.$validate.on("click",async function(evt){evt.preventDefault(),evt.stopImmediatePropagation(),await instance.validate()?instance.hide(()=>{instance.$otp.trigger("otp:valid"),instance.$form.off("submit",onSubmit).submit()}):(instance.$otp.trigger("otp:invalid"),instance.$otp.addClass("invalid"))})):instance.$validate.on("click",async function(evt){evt.preventDefault(),evt.stopImmediatePropagation(),await instance.validate()?instance.hide(()=>{instance.$otp.trigger("otp:valid")}):(instance.$otp.trigger("otp:invalid"),instance.$otp.addClass("invalid"))}),this.data("otp",instance),this.append(instance.$otp),this}}(jQuery);